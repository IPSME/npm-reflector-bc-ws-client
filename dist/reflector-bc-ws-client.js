/*! For license information please see reflector-bc-ws-client.js.LICENSE.txt */
(()=>{"use strict";function e(e,t){let n={};for(var[o,r]of Object.entries(e))n[o]=r<<t;return n}function t(){var e=Array.prototype.slice.call(arguments);console.log.apply(console,e)}class n{constructor(){this._handler_log=t,this._Bint_labels=BigInt(0),this._Bint_toggled=BigInt(0),n.prototype.log=function(e){}}set handler(e){this._handler_log=e}get labels(){return this._Bint_labels}set labels(e){this._Bint_labels=e,this._Bint_toggled=BigInt(0)}get toggled(){return this._Bint_toggled}set toggled(e){this._Bint_toggled=function(e,t,n=!1){let o=BigInt(0);for(const[r,s]of Object.entries(t))(n||s)&&e[r]&&(o|=BigInt(e[r]));return o}(this._Bint_labels,e),n.prototype.log=function(e){if((BigInt(e)&this._Bint_toggled)===BigInt(0))return!1;var t=Array.prototype.slice.call(arguments);return t.shift(),this._handler_log.apply(this,t),!0}}}function o(){var e=Array.prototype.slice.call(arguments);console.log.apply(console,e)}class r{constructor(){this._handler_log=o,this._Bint_labels=BigInt(0),this._Bint_toggled=BigInt(0),r.prototype.log=function(e){}}set handler(e){this._handler_log=e}get labels(){return this._Bint_labels}set labels(e){this._Bint_labels=e,this._Bint_toggled=BigInt(0)}get toggled(){return this._Bint_toggled}set toggled(e){this._Bint_toggled=function(e,t,n=!1){let o=BigInt(0);for(const[r,s]of Object.entries(t))(n||s)&&e[r]&&(o|=BigInt(e[r]));return o}(this._Bint_labels,e),r.prototype.log=function(e){if((BigInt(e)&this._Bint_toggled)===BigInt(0))return!1;var t=Array.prototype.slice.call(arguments);return t.shift(),this._handler_log.apply(this,t),!0}}}let s=new r;const i={MsgEnv:1,CXNS:2,REFL:4};s.labels=i;var l=function(){let e={};return{get channel(){return void 0===e.channel?"IPSME":e.channel},get prefix(){return void 0===e.prefix?"":e.prefix},get options(){return e},set options(t){e=t,e.logr&&e.logr[(e=>Object.keys(e)[0])(i)]&&(s.toggled=e.logr)}}}(),c=void 0;function a(){var e=Array.prototype.slice.call(arguments);console.log.apply(console,e)}class u{constructor(){this._handler_log=a,this._Bint_labels=BigInt(0),this._Bint_toggled=BigInt(0),u.prototype.log=function(e){}}set handler(e){this._handler_log=e}get labels(){return this._Bint_labels}set labels(e){this._Bint_labels=e,this._Bint_toggled=BigInt(0)}get toggled(){return this._Bint_toggled}set toggled(e){this._Bint_toggled=function(e,t,n=!1){let o=BigInt(0);for(const[r,s]of Object.entries(t))(n||s)&&e[r]&&(o|=BigInt(e[r]));return o}(this._Bint_labels,e),u.prototype.log=function(e){if((BigInt(e)&this._Bint_toggled)===BigInt(0))return!1;var t=Array.prototype.slice.call(arguments);return t.shift(),this._handler_log.apply(this,t),!0}}}let h=new u;const _={MsgCache:1,ADD_REMOVE:2};h.labels=_;let g={};class p{constructor(e=3e4,t){this._TTL_ms=e,this._context=t,this._expired=!1,this._timeout_ID=setTimeout((function(e){e.expire()}),this._TTL_ms,this)}expire(){this._expired=!0,clearTimeout(this._timeout_ID)}get TTL(){return this._TTL_ms}get context(){return this._context}get expired(){return this._expired}}var d=function(e,t){return d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},d(e,t)};function f(e,t){function n(){this.constructor=e}d(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function y(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,s=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(o=s.next()).done;)i.push(o.value)}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return i}function b(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(y(arguments[t]));return e}var m=function(e,t){this.target=t,this.type=e},v=function(e){function t(t,n){var o=e.call(this,"error",n)||this;return o.message=t.message,o.error=t,o}return f(t,e),t}(m),w=function(e){function t(t,n,o){void 0===t&&(t=1e3),void 0===n&&(n="");var r=e.call(this,"close",o)||this;return r.wasClean=!0,r.code=t,r.reason=n,r}return f(t,e),t}(m),E=function(){if("undefined"!=typeof WebSocket)return WebSocket},L={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1};const C=function(){function e(e,t,n){var o=this;void 0===n&&(n={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(e){o._debug("open event");var t=o._options.minUptime,n=void 0===t?L.minUptime:t;clearTimeout(o._connectTimeout),o._uptimeTimeout=setTimeout((function(){return o._acceptOpen()}),n),o._ws.binaryType=o._binaryType,o._messageQueue.forEach((function(e){return o._ws.send(e)})),o._messageQueue=[],o.onopen&&o.onopen(e),o._listeners.open.forEach((function(t){return o._callEventListener(e,t)}))},this._handleMessage=function(e){o._debug("message event"),o.onmessage&&o.onmessage(e),o._listeners.message.forEach((function(t){return o._callEventListener(e,t)}))},this._handleError=function(e){o._debug("error event",e.message),o._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),o.onerror&&o.onerror(e),o._debug("exec error listeners"),o._listeners.error.forEach((function(t){return o._callEventListener(e,t)})),o._connect()},this._handleClose=function(e){o._debug("close event"),o._clearTimeouts(),o._shouldReconnect&&o._connect(),o.onclose&&o.onclose(e),o._listeners.close.forEach((function(t){return o._callEventListener(e,t)}))},this._url=e,this._protocols=t,this._options=n,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(e,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CONNECTING",{get:function(){return e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"OPEN",{get:function(){return e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSING",{get:function(){return e.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSED",{get:function(){return e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce((function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e}),0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?e.CLOSED:e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()},e.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,n=void 0===t?L.maxEnqueuedMessages:t;this._messageQueue.length<n&&(this._debug("enqueue",e),this._messageQueue.push(e))}},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.dispatchEvent=function(e){var t,n,o=this._listeners[e.type];if(o)try{for(var r=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}(o),s=r.next();!s.done;s=r.next()){var i=s.value;this._callEventListener(e,i)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return!0},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((function(e){return e!==t})))},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,b(["RWS>"],e))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=void 0===t?L.reconnectionDelayGrowFactor:t,o=e.minReconnectionDelay,r=void 0===o?L.minReconnectionDelay:o,s=e.maxReconnectionDelay,i=void 0===s?L.maxReconnectionDelay:s,l=0;return this._retryCount>0&&(l=r*Math.pow(n,this._retryCount-1))>i&&(l=i),this._debug("next delay",l),l},e.prototype._wait=function(){var e=this;return new Promise((function(t){setTimeout(t,e._getNextDelay())}))},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options,n=t.maxRetries,o=void 0===n?L.maxRetries:n,r=t.connectionTimeout,s=void 0===r?L.connectionTimeout:r,i=t.WebSocket,l=void 0===i?E():i;if(this._retryCount>=o)this._debug("max retries reached",this._retryCount,">=",o);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),void 0===(c=l)||!c||2!==c.CLOSING)throw Error("No valid WebSocket class provided");var c;this._wait().then((function(){return e._getNextUrl(e._url)})).then((function(t){e._closeCalled||(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new l(t,e._protocols):new l(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout((function(){return e._handleTimeout()}),s))}))}}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new v(Error("TIMEOUT"),this))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new w(e,t,this))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}();var O=void 0;let T=new class{constructor(e=1e3){this._map_messages=new Map,this._interval_ID=setInterval((function(e){for(const[t,n]of e._map_messages.entries())n.expired&&(e._map_messages.delete(t),h.log(_.ADD_REMOVE,"msgCache: expired: *DELETED msg: ",t,n.TTL))}),e,this)}cache(e,t){h.log(_.ADD_REMOVE,"msgCache: cache: ",e),this._map_messages.set(e,t)}contains(e){let t=this._map_messages.get(e);return[void 0!==t,t]}exists(e){return this._map_messages.has(e)}expire(e){let[t,n]=this.contains(e);t&&(n.expire(),this._map_messages.delete(e))}static set options(e){g=e,g.logr&&g.logr[(e=>Object.keys(e)[0])(_)]&&(h.toggled=g.logr)}},B=new n;const x={DUPS:2,...e(i,4),...e(_,8)};B.labels=x;var I,S,N=function(){let e={};return{get url(){return void 0===e.url?"ws://localhost:8082":e.url},get rws(){return void 0===e.rws?{}:e.rws},get logr(){return void 0===e.logr?0:e.logr},get options(){return e},set options(t){e=t},is_empty:function(){return 0===Object.keys(e).length}}}();function R(e){B.log(x.CXNS,"REFL-ws: open: ",e),S.postMessage({sharedworker:"INITd!"})}function D(e){B.log(x.CXNS,"REFL-ws: close: ",e)}function P(e){if(void 0===e.data)return;console.assert("string"==typeof e.data,"a msg coming from NSDNC must be a string");const t=e.data;let[n,o]=T.contains(t);var r;n?B.log(x.DUPS,"REFL-ws: *DUP | <- ws -- ",t):(B.log(x.REFL,"REFL-ws: publish: bc <- ws -- ",t),r=t,c||(c=new BroadcastChannel(l.channel)),s.log(i.REFL,l.prefix+"MsgEnv: bc.postMessage: ",r),c.postMessage(r))}function M(e){B.log(x.CXNS,"REFL-ws: err: ",e)}void 0===(I=function(e){if(void 0===e)return;if("string"!=typeof e)return;let t=e;T.cache(t,new p(4e3)),B.log(x.REFL,"REFL-ws: send: bc -> ws -- ",t),O&&O.readyState===WebSocket.OPEN&&O.send(t)}).broadcastChannel&&(s.log(i.CXNS,l.prefix+"MsgEnv: subscribe"),(I.broadcastChannel=new BroadcastChannel(l.channel)).onmessage=function(e){const t=e.data;s.log(i.REFL,l.prefix+"MsgEnv: bc.onmessage: ",t),this(t)}.bind(I));var j=[];onconnect=function(e){S=e.ports[0];const t=j.find((e=>e===S));void 0!==t&&null!=t||j.push(S),S.onmessage=function(e){B.log(x.CXNS,"REFL: port.onmessage: options: ",N.options),O?O.readyState===WebSocket.OPEN&&S.postMessage({sharedworker:"INITd!"}):(N.options=e.data,l.options={prefix:"REFL-ws: ",logr:N.options},(O=new C(N.url,[],N.rws)).onopen=R,O.onclose=D,O.onmessage=P,O.onerror=M,B.log(x.CXNS,"REFL: rws:",O))}}})();